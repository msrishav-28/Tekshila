<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Tekshila - AI-Powered Code Documentation</title>
    <link rel="stylesheet" href="styles.css">
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css">
    <link rel="icon" type="image/svg+xml" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ðŸ§ </text></svg>">
</head>
<body>
    <div class="app-container">
        <!-- Navigation Header -->
        <header class="header glass-effect">
            <div class="header-content">
                <div class="logo">
                    <div class="logo-icon">
                        <i class="fas fa-brain"></i>
                    </div>
                    <div class="logo-text">
                        <h1>Tekshila</h1>
                        <span>AI-Powered Documentation</span>
                    </div>
                </div>
                
                <nav class="nav-tabs glass-nav">
                    <button class="nav-tab active" data-tab="documentation">
                        <i class="fas fa-file-alt"></i>
                        <span>Documentation</span>
                    </button>
                    <button class="nav-tab" data-tab="github">
                        <i class="fab fa-github"></i>
                        <span>GitHub</span>
                    </button>
                    <button class="nav-tab" data-tab="quality">
                        <i class="fas fa-microscope"></i>
                        <span>Quality Analysis</span>
                    </button>
                </nav>

                <div class="header-actions">
                    <div class="github-status connected glass-card" id="githubStatus">
                        <img class="user-avatar" id="userAvatar" src="" alt="User Avatar">
                        <div class="user-info">
                            <span class="user-name" id="userName">Loading...</span>
                            <span class="connection-status">Connected</span>
                        </div>
                    </div>
                    <button class="btn btn-secondary glass-button" id="logoutBtn">
                        <i class="fas fa-sign-out-alt"></i>
                        <span>Logout</span>
                    </button>
                    <button class="theme-toggle glass-button" id="themeToggle">
                        <i class="fas fa-moon"></i>
                    </button>
                </div>
            </div>
        </header>

        <!-- Main Content -->
        <main class="main-content">
            <!-- Documentation Tab -->
            <div class="tab-content active" id="documentation">
                <div class="hero-section">
                    <div class="hero-content">
                        <h1>Generate Smart Documentation</h1>
                        <p>Transform your code into comprehensive documentation with AI-powered analysis</p>
                    </div>
                </div>

                <div class="content-container">
                    <div class="content-grid">
                        <!-- Upload Section -->
                        <div class="upload-panel">
                            <div class="panel-header">
                                <h2>Upload Your Code</h2>
                                <div class="purpose-toggle">
                                    <input type="radio" id="readme" name="purpose" value="readme" checked>
                                    <label for="readme">README</label>
                                    <input type="radio" id="comments" name="purpose" value="comments">
                                    <label for="comments">Comments</label>
                                </div>
                            </div>

                            <div class="upload-zone" id="uploadZone">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-cloud-upload-alt"></i>
                                    </div>
                                    <h3>Drop files here or click to browse</h3>
                                    <p>Supports Python, JavaScript, TypeScript, Java, C++, and more</p>
                                    <div class="upload-formats">
                                        <span class="format-tag">.py</span>
                                        <span class="format-tag">.js</span>
                                        <span class="format-tag">.ts</span>
                                        <span class="format-tag">.java</span>
                                        <span class="format-tag">.zip</span>
                                    </div>
                                </div>
                                <input type="file" id="fileInput" multiple accept=".py,.js,.jsx,.ts,.tsx,.java,.c,.cpp,.cs,.go,.rs,.php,.rb,.swift,.kt,.zip">
                            </div>

                            <div class="uploaded-files" id="uploadedFiles"></div>

                            <div class="form-section">
                                <div class="input-group">
                                    <label for="projectName">Project Name</label>
                                    <input type="text" id="projectName" placeholder="Project Name">
                                </div>

                                <div class="input-group">
                                    <label for="customInstructions">Additional Instructions</label>
                                    <textarea id="customInstructions" placeholder="Additional Instructions"></textarea>
                                </div>

                                <button class="btn btn-primary btn-large" id="generateBtn">
                                    <i class="fas fa-magic"></i>
                                    <span>Generate Documentation</span>
                                </button>
                            </div>
                        </div>

                        <!-- Preview Section -->
                        <div class="preview-panel">
                            <div class="panel-header">
                                <h2>Preview</h2>
                                <div class="preview-actions">
                                    <button class="btn btn-secondary" id="copyBtn" disabled>
                                        <i class="fas fa-copy"></i>
                                        Copy
                                    </button>
                                    <button class="btn btn-secondary" id="downloadBtn" disabled>
                                        <i class="fas fa-download"></i>
                                        Download
                                    </button>
                                </div>
                            </div>
                            
                            <div class="preview-container" id="previewContainer">
                                <div class="preview-placeholder">
                                    <div class="placeholder-icon">
                                        <i class="fas fa-eye"></i>
                                    </div>
                                    <h3>Documentation Preview</h3>
                                    <p>Your generated documentation will appear here</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- GitHub Tab -->
            <div class="tab-content" id="github">
                <div class="hero-section">
                    <div class="hero-content">
                        <h1>GitHub Integration</h1>
                        <p>Access your repositories and create pull requests with your documentation</p>
                    </div>
                </div>

                <div class="content-container">
                    <div class="content-grid">
                        <!-- Repository Browser -->
                        <div class="github-panel">
                            <div class="panel-header">
                                <h2>Your Repositories</h2>
                                <div class="repo-filters">
                                    <input type="text" id="repoSearch" placeholder="Search repositories..." class="search-input">
                                    <select id="repoSort" class="sort-select">
                                        <option value="updated">Recently updated</option>
                                        <option value="created">Recently created</option>
                                        <option value="name">Name</option>
                                        <option value="stars">Stars</option>
                                    </select>
                                </div>
                            </div>

                            <div class="repo-list" id="repoList">
                                <div class="repo-loading">
                                    <div class="loading-spinner-small"></div>
                                    <span>Loading repositories...</span>
                                </div>
                            </div>
                        </div>

                        <!-- Repository Details & PR Creation -->
                        <div class="pr-panel">
                            <div class="panel-header">
                                <h2>Repository Details</h2>
                            </div>
                            
                            <div class="repo-details" id="repoDetails">
                                <div class="pr-placeholder" id="prPlaceholder">
                                    <div class="placeholder-icon">
                                        <i class="fab fa-github"></i>
                                    </div>
                                    <h3>Select a Repository</h3>
                                    <p>Choose a repository from the list to view details and create pull requests</p>
                                </div>
                            </div>

                            <div class="pr-form" id="prForm" style="display: none;">
                                <div class="selected-repo-info" id="selectedRepoInfo"></div>
                                
                                <div class="input-group">
                                    <label for="branchSelect">Target Branch</label>
                                    <select id="branchSelect">
                                        <option value="">Loading branches...</option>
                                    </select>
                                </div>

                                <div class="input-group">
                                    <label for="prTitle">PR Title</label>
                                    <input type="text" id="prTitle" placeholder="Add AI-generated documentation">
                                </div>

                                <div class="input-group">
                                    <label for="prDescription">Description</label>
                                    <textarea id="prDescription" placeholder="This PR adds comprehensive documentation generated by AI..."></textarea>
                                </div>

                                <div class="input-group">
                                    <label for="commitMessage">Commit Message</label>
                                    <input type="text" id="commitMessage" placeholder="docs: add AI-generated documentation">
                                </div>

                                <button class="btn btn-primary btn-large" id="createPrBtn" disabled>
                                    <i class="fas fa-code-branch"></i>
                                    <span>Create Pull Request</span>
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Quality Analysis Tab -->
            <div class="tab-content" id="quality">
                <div class="hero-section">
                    <div class="hero-content">
                        <h1>Code Quality Analysis</h1>
                        <p>Get AI-powered insights into your code quality and best practices</p>
                    </div>
                </div>

                <div class="content-container">
                    <div class="content-grid">
                        <!-- Analysis Upload -->
                        <div class="analysis-panel">
                            <div class="panel-header">
                                <h2>Upload for Analysis</h2>
                            </div>
                            
                            <div class="upload-zone" id="qualityUploadZone">
                                <div class="upload-content">
                                    <div class="upload-icon">
                                        <i class="fas fa-search-plus"></i>
                                    </div>
                                    <h3>Drop a file here or click to browse</h3>
                                    <p>Upload a single file for quality analysis</p>
                                </div>
                                <input type="file" id="qualityFileInput" accept=".py,.js,.jsx,.ts,.tsx,.java,.c,.cpp,.cs,.go,.rs,.php,.rb,.swift,.kt">
                            </div>

                            <div class="uploaded-files" id="qualityUploadedFiles"></div>

                            <button class="btn btn-primary btn-large" id="analyzeBtn" disabled>
                                <i class="fas fa-microscope"></i>
                                <span>Analyze Code Quality</span>
                            </button>
                        </div>

                        <!-- Analysis Results -->
                        <div class="results-panel">
                            <div class="panel-header">
                                <h2>Analysis Results</h2>
                            </div>
                            
                            <div class="results-container" id="resultsContainer">
                                <div class="results-placeholder">
                                    <div class="placeholder-icon">
                                        <i class="fas fa-chart-line"></i>
                                    </div>
                                    <h3>Quality Insights</h3>
                                    <p>Upload a file and run analysis to see detailed results</p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Loading Overlay -->
        <div class="loading-overlay" id="loadingOverlay">
            <div class="loading-content">
                <div class="loading-spinner">
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                    <div class="spinner-ring"></div>
                </div>
                <h3 id="loadingText">Processing...</h3>
                <p id="loadingSubtext">Please wait while we analyze your code</p>
            </div>
        </div>

        <!-- Toast Container -->
        <div class="toast-container" id="toastContainer"></div>
    </div>

    <script>
        // API Configuration with health check
        const API_CONFIG = {
            baseUrl: '', // Use relative URLs for Vercel
            endpoints: {
                auth: '/api/auth/user',
                logout: '/api/auth/logout',
                repos: '/api/github/repos',
                branches: '/api/github/repos',
                createPR: '/api/github/repos',
                config: '/api/config',
                health: '/api/health'
            }
        };

        // Health check function
        async function checkAPIHealth() {
            try {
                const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.health}`);
                if (response.ok) {
                    const health = await response.json();
                    console.log('API Health Check:', health);
                    return health;
                }
            } catch (error) {
                console.error('API Health Check Failed:', error);
                return null;
            }
        }

        // Application State Management
        class AppState {
            constructor() {
                this.currentTab = 'documentation';
                this.githubUser = null;
                this.githubToken = null;
                this.repositories = [];
                this.selectedRepo = null;
                this.selectedBranch = '';
                this.uploadedFiles = [];
                this.qualityFile = null;
                this.generatedContent = '';
                this.currentPurpose = 'readme';
                this.theme = localStorage.getItem('theme') || 'light';
            }

            updateState(key, value) {
                this[key] = value;
                this.notifyStateChange(key, value);
            }

            notifyStateChange(key, value) {
                window.dispatchEvent(new CustomEvent('stateChange', {
                    detail: { key, value }
                }));
            }
        }

        // Utility Functions
        class Utils {
            static formatFileSize(bytes) {
                if (bytes === 0) return '0 Bytes';
                const k = 1024;
                const sizes = ['Bytes', 'KB', 'MB', 'GB'];
                const i = Math.floor(Math.log(bytes) / Math.log(k));
                return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
            }

            static getFileExtension(filename) {
                return filename.split('.').pop().toLowerCase();
            }

            static getFileIcon(filename) {
                const ext = Utils.getFileExtension(filename);
                const iconMap = {
                    'py': 'fab fa-python',
                    'js': 'fab fa-js-square',
                    'jsx': 'fab fa-react',
                    'ts': 'fab fa-js-square',
                    'tsx': 'fab fa-react',
                    'java': 'fab fa-java',
                    'html': 'fab fa-html5',
                    'css': 'fab fa-css3-alt',
                    'php': 'fab fa-php',
                    'rb': 'fas fa-gem',
                    'go': 'fab fa-golang',
                    'rs': 'fab fa-rust',
                    'swift': 'fab fa-swift',
                    'kt': 'fas fa-code',
                    'zip': 'fas fa-file-archive',
                    'c': 'fas fa-code',
                    'cpp': 'fas fa-code',
                    'cs': 'fas fa-code'
                };
                return iconMap[ext] || 'fas fa-file-code';
            }

            static showToast(message, type = 'info', duration = 5000) {
                const toastContainer = document.getElementById('toastContainer');
                const toast = document.createElement('div');
                toast.className = `toast ${type}`;
                
                const iconMap = {
                    success: 'fas fa-check-circle',
                    error: 'fas fa-exclamation-circle',
                    warning: 'fas fa-exclamation-triangle',
                    info: 'fas fa-info-circle'
                };

                toast.innerHTML = `
                    <i class="toast-icon ${iconMap[type]}"></i>
                    <div class="toast-message">${message}</div>
                `;

                toastContainer.appendChild(toast);

                setTimeout(() => {
                    toast.style.animation = 'slideIn 0.3s ease-out reverse';
                    setTimeout(() => {
                        if (toast.parentNode) {
                            toast.parentNode.removeChild(toast);
                        }
                    }, 300);
                }, duration);
            }

            static showLoading(text = 'Processing...', subtext = 'Please wait while we analyze your code') {
                const overlay = document.getElementById('loadingOverlay');
                const loadingText = document.getElementById('loadingText');
                const loadingSubtext = document.getElementById('loadingSubtext');
                
                loadingText.textContent = text;
                loadingSubtext.textContent = subtext;
                overlay.classList.add('active');
            }

            static hideLoading() {
                const overlay = document.getElementById('loadingOverlay');
                overlay.classList.remove('active');
            }

            static async copyToClipboard(text) {
                try {
                    await navigator.clipboard.writeText(text);
                    Utils.showToast('Copied to clipboard!', 'success');
                } catch (err) {
                    const textArea = document.createElement('textarea');
                    textArea.value = text;
                    document.body.appendChild(textArea);
                    textArea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textArea);
                    Utils.showToast('Copied to clipboard!', 'success');
                }
            }

            static timeAgo(date) {
                const now = new Date();
                const diffTime = Math.abs(now - new Date(date));
                const diffDays = Math.floor(diffTime / (1000 * 60 * 60 * 24));
                
                if (diffDays === 0) return 'Today';
                if (diffDays === 1) return 'Yesterday';
                if (diffDays < 7) return `${diffDays} days ago`;
                if (diffDays < 30) return `${Math.floor(diffDays / 7)} weeks ago`;
                if (diffDays < 365) return `${Math.floor(diffDays / 30)} months ago`;
                return `${Math.floor(diffDays / 365)} years ago`;
            }

            static animateElement(element, animation) {
                element.classList.add('animated', animation);
                element.addEventListener('animationend', () => {
                    element.classList.remove('animated', animation);
                }, { once: true });
            }

            static updateLoadingProgress(percent) {
                const spinner = document.querySelector('.loading-spinner');
                const rings = spinner.querySelectorAll('.spinner-ring');
                
                rings.forEach((ring, index) => {
                    setTimeout(() => {
                        ring.style.transform = `rotate(${(percent / 100) * 360}deg)`;
                    }, index * 100);
                });
            }

            static showSuccess(message) {
                Utils.showToast(message, 'success');
            }
        }

        // Updated Authentication Manager for Vercel
        class AuthManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                // Check authentication status on load
                this.checkAuth();
                
                // Set up logout handler
                document.getElementById('logoutBtn').addEventListener('click', () => {
                    this.logout();
                });

                // Handle OAuth callback success
                const urlParams = new URLSearchParams(window.location.search);
                if (urlParams.get('auth') === 'success') {
                    // Clear the URL parameter
                    window.history.replaceState({}, document.title, window.location.pathname);
                    Utils.showToast('Successfully logged in with GitHub!', 'success');
                    this.checkAuth();
                }

                // Handle OAuth errors
                if (urlParams.get('error')) {
                    const error = decodeURIComponent(urlParams.get('error'));
                    Utils.showToast(`Login failed: ${error}`, 'error');
                    window.history.replaceState({}, document.title, '/login.html');
                }
            }

            async checkAuth() {
                try {
                    // First check API health
                    const health = await checkAPIHealth();
                    if (!health) {
                        console.warn('API health check failed, but attempting auth anyway...');
                    }

                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.auth}`, {
                        credentials: 'include',
                        headers: {
                            'Content-Type': 'application/json'
                        }
                    });

                    if (response.ok) {
                        const data = await response.json();
                        this.appState.updateState('githubUser', data.user);
                        this.appState.updateState('githubToken', data.token);
                        this.updateUserDisplay(data.user);
                        
                        // Load repositories if on GitHub tab
                        if (this.appState.currentTab === 'github') {
                            window.githubManager?.loadRepositories();
                        }
                    } else if (response.status === 401) {
                        console.log('User not authenticated, redirecting to login');
                        this.redirectToLogin();
                    } else {
                        console.error('Auth check failed with status:', response.status);
                        Utils.showToast('Authentication check failed. Please try logging in again.', 'error');
                        this.redirectToLogin();
                    }
                } catch (error) {
                    console.error('Auth check failed:', error);
                    
                    // Show more helpful error message
                    if (error.message.includes('fetch')) {
                        Utils.showToast('Unable to connect to server. Please check your connection and try again.', 'error');
                    } else {
                        Utils.showToast('Authentication failed. Please try logging in again.', 'error');
                    }
                    
                    this.redirectToLogin();
                }
            }

            updateUserDisplay(user) {
                document.getElementById('userAvatar').src = user.avatar_url;
                document.getElementById('userName').textContent = user.name || user.login;
            }

            async logout() {
                try {
                    await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.logout}`, {
                        method: 'POST',
                        credentials: 'include'
                    });
                } catch (error) {
                    console.error('Logout error:', error);
                } finally {
                    this.redirectToLogin();
                }
            }

            redirectToLogin() {
                window.location.href = '/login.html';
            }
        }

        // Theme Manager
        class ThemeManager {
            constructor() {
                this.init();
            }

            init() {
                const themeToggle = document.getElementById('themeToggle');
                const savedTheme = localStorage.getItem('theme') || 'light';
                
                this.setTheme(savedTheme);
                
                themeToggle.addEventListener('click', () => {
                    const currentTheme = document.documentElement.getAttribute('data-theme') || 'light';
                    const newTheme = currentTheme === 'light' ? 'dark' : 'light';
                    this.setTheme(newTheme);
                });
            }

            setTheme(theme) {
                document.documentElement.setAttribute('data-theme', theme);
                localStorage.setItem('theme', theme);
                
                const themeToggle = document.getElementById('themeToggle');
                const icon = themeToggle.querySelector('i');
                
                if (theme === 'dark') {
                    icon.className = 'fas fa-sun';
                } else {
                    icon.className = 'fas fa-moon';
                }
            }
        }

        // Tab Manager
        class TabManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                const navTabs = document.querySelectorAll('.nav-tab');
                navTabs.forEach(tab => {
                    tab.addEventListener('click', (e) => {
                        const tabName = e.currentTarget.dataset.tab;
                        this.switchTab(tabName);
                    });
                });
            }

            switchTab(tabName) {
                document.querySelectorAll('.nav-tab').forEach(tab => {
                    tab.classList.remove('active');
                });
                document.querySelector(`[data-tab="${tabName}"]`).classList.add('active');

                document.querySelectorAll('.tab-content').forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabName).classList.add('active');

                this.appState.updateState('currentTab', tabName);

                // Load repositories when switching to GitHub tab
                if (tabName === 'github' && this.appState.githubUser && window.githubManager) {
                    if (this.appState.repositories.length === 0) {
                        window.githubManager.loadRepositories();
                    }
                }
            }
        }

        // File Upload Manager
        class FileUploadManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                this.setupUploadZone('uploadZone', 'fileInput', false);
                this.setupUploadZone('qualityUploadZone', 'qualityFileInput', true);

                const purposeRadios = document.querySelectorAll('input[name="purpose"]');
                purposeRadios.forEach(radio => {
                    radio.addEventListener('change', (e) => {
                        this.appState.updateState('currentPurpose', e.target.value);
                    });
                });
            }

            setupUploadZone(zoneId, inputId, isQuality) {
                const uploadZone = document.getElementById(zoneId);
                const fileInput = document.getElementById(inputId);

                uploadZone.addEventListener('click', () => {
                    fileInput.click();
                });

                uploadZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    uploadZone.classList.add('dragover');
                });

                uploadZone.addEventListener('dragleave', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                });

                uploadZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    uploadZone.classList.remove('dragover');
                    this.handleFiles(e.dataTransfer.files, isQuality);
                });

                fileInput.addEventListener('change', (e) => {
                    this.handleFiles(e.target.files, isQuality);
                });
            }

            handleFiles(files, isQuality = false) {
                if (isQuality) {
                    if (files.length > 0) {
                        this.appState.updateState('qualityFile', files[0]);
                        this.displayQualityFile(files[0]);
                        document.getElementById('analyzeBtn').disabled = false;
                    }
                } else {
                    const newFiles = Array.from(files).filter(file => 
                        !this.appState.uploadedFiles.find(f => f.name === file.name)
                    );
                    
                    this.appState.uploadedFiles.push(...newFiles);
                    this.displayUploadedFiles();
                }
            }

            displayUploadedFiles() {
                const container = document.getElementById('uploadedFiles');
                container.innerHTML = '';

                this.appState.uploadedFiles.forEach((file, index) => {
                    const fileItem = document.createElement('div');
                    fileItem.className = 'file-item';
                    fileItem.innerHTML = `
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="${Utils.getFileIcon(file.name)}"></i>
                            </div>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <p>${Utils.formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <button class="file-remove" onclick="fileUploadManager.removeFile(${index})">
                            <i class="fas fa-times"></i>
                        </button>
                    `;
                    container.appendChild(fileItem);
                });
            }

            displayQualityFile(file) {
                const container = document.getElementById('qualityUploadedFiles');
                container.innerHTML = `
                    <div class="file-item">
                        <div class="file-info">
                            <div class="file-icon">
                                <i class="${Utils.getFileIcon(file.name)}"></i>
                            </div>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <p>${Utils.formatFileSize(file.size)}</p>
                            </div>
                        </div>
                        <button class="file-remove" onclick="fileUploadManager.removeQualityFile()">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                `;
            }

            removeFile(index) {
                this.appState.uploadedFiles.splice(index, 1);
                this.displayUploadedFiles();
            }

            removeQualityFile() {
                this.appState.updateState('qualityFile', null);
                document.getElementById('qualityUploadedFiles').innerHTML = '';
                document.getElementById('analyzeBtn').disabled = true;
            }
        }

        // Updated GitHub Repository Manager for Vercel
        class GitHubRepositoryManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                this.setupEventListeners();
            }

            setupEventListeners() {
                const repoSearch = document.getElementById('repoSearch');
                const repoSort = document.getElementById('repoSort');
                const createPrBtn = document.getElementById('createPrBtn');
                const branchSelect = document.getElementById('branchSelect');

                repoSearch.addEventListener('input', (e) => {
                    this.filterRepositories(e.target.value);
                });

                repoSort.addEventListener('change', (e) => {
                    this.sortRepositories(e.target.value);
                });

                branchSelect.addEventListener('change', (e) => {
                    this.appState.updateState('selectedBranch', e.target.value);
                });

                createPrBtn.addEventListener('click', () => {
                    this.createPullRequest();
                });
            }

            async loadRepositories() {
                try {
                    Utils.showLoading('Loading repositories...', 'Fetching your GitHub repositories');
                    
                    const response = await fetch(`${API_CONFIG.baseUrl}${API_CONFIG.endpoints.repos}`, {
                        credentials: 'include'
                    });

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const repos = await response.json();
                    this.appState.updateState('repositories', repos);
                    this.displayRepositories(repos);
                    
                } catch (error) {
                    console.error('Failed to load repositories:', error);
                    Utils.showToast('Failed to load repositories', 'error');
                    this.displayError('Failed to load repositories');
                } finally {
                    Utils.hideLoading();
                }
            }

            displayRepositories(repos) {
                const repoList = document.getElementById('repoList');
                
                if (repos.length === 0) {
                    repoList.innerHTML = `
                        <div class="no-repos">
                            <i class="fab fa-github"></i>
                            <h3>No repositories found</h3>
                            <p>Create your first repository on GitHub to get started</p>
                        </div>
                    `;
                    return;
                }

                repoList.innerHTML = repos.map(repo => `
                    <div class="repo-item" data-repo-id="${repo.id}" onclick="githubManager.selectRepository(${repo.id})">
                        <div class="repo-info">
                            <div class="repo-header">
                                <h3 class="repo-name">${repo.name}</h3>
                                <div class="repo-badges">
                                    ${repo.private ? '<span class="badge private">Private</span>' : '<span class="badge public">Public</span>'}
                                    ${repo.language ? `<span class="badge language">${repo.language}</span>` : ''}
                                </div>
                            </div>
                            <p class="repo-description">${repo.description || 'No description available'}</p>
                            <div class="repo-stats">
                                <span class="stat">
                                    <i class="fas fa-star"></i>
                                    ${repo.stargazers_count}
                                </span>
                                <span class="stat">
                                    <i class="fas fa-code-branch"></i>
                                    ${repo.forks_count}
                                </span>
                                <span class="stat">
                                    <i class="fas fa-clock"></i>
                                    ${Utils.timeAgo(repo.updated_at)}
                                </span>
                            </div>
                        </div>
                        <div class="repo-actions">
                            <i class="fas fa-chevron-right"></i>
                        </div>
                    </div>
                `).join('');
            }

            displayError(message) {
                const repoList = document.getElementById('repoList');
                repoList.innerHTML = `
                    <div class="error-state">
                        <i class="fas fa-exclamation-triangle"></i>
                        <h3>Error Loading Repositories</h3>
                        <p>${message}</p>
                        <button class="retry-btn" onclick="githubManager.loadRepositories()">
                            <i class="fas fa-redo"></i> Retry
                        </button>
                    </div>
                `;
            }

            filterRepositories(searchTerm) {
                const filteredRepos = this.appState.repositories.filter(repo =>
                    repo.name.toLowerCase().includes(searchTerm.toLowerCase()) ||
                    (repo.description && repo.description.toLowerCase().includes(searchTerm.toLowerCase()))
                );
                this.displayRepositories(filteredRepos);
            }

            sortRepositories(sortBy) {
                let sortedRepos = [...this.appState.repositories];
                
                switch (sortBy) {
                    case 'updated':
                        sortedRepos.sort((a, b) => new Date(b.updated_at) - new Date(a.updated_at));
                        break;
                    case 'created':
                        sortedRepos.sort((a, b) => new Date(b.created_at) - new Date(a.created_at));
                        break;
                    case 'name':
                        sortedRepos.sort((a, b) => a.name.localeCompare(b.name));
                        break;
                    case 'stars':
                        sortedRepos.sort((a, b) => b.stargazers_count - a.stargazers_count);
                        break;
                }
                
                this.displayRepositories(sortedRepos);
            }

            async selectRepository(repoId) {
                const repo = this.appState.repositories.find(r => r.id === repoId);
                if (!repo) return;

                this.appState.updateState('selectedRepo', repo);
                
                // Update UI to show selected repo
                document.querySelectorAll('.repo-item').forEach(item => {
                    item.classList.remove('selected');
                });
                document.querySelector(`[data-repo-id="${repoId}"]`).classList.add('selected');

                // Show repository details and PR form
                this.displayRepositoryDetails(repo);
                
                // Load branches
                await this.loadBranches(repo);
            }

            displayRepositoryDetails(repo) {
                const repoDetails = document.getElementById('repoDetails');
                const prForm = document.getElementById('prForm');
                const prPlaceholder = document.getElementById('prPlaceholder');
                const selectedRepoInfo = document.getElementById('selectedRepoInfo');

                prPlaceholder.style.display = 'none';
                prForm.style.display = 'block';

                selectedRepoInfo.innerHTML = `
                    <div class="selected-repo">
                        <div class="repo-avatar">
                            <i class="fab fa-github"></i>
                        </div>
                        <div class="repo-details">
                            <h4>${repo.name}</h4>
                            <p>${repo.full_name}</p>
                            <div class="repo-meta">
                                <span class="meta-item">
                                    <i class="fas fa-star"></i>
                                    ${repo.stargazers_count} stars
                                </span>
                                <span class="meta-item">
                                    <i class="fas fa-code-branch"></i>
                                    ${repo.forks_count} forks
                                </span>
                            </div>
                        </div>
                    </div>
                `;

                // Enable PR creation if documentation is generated
                if (this.appState.generatedContent) {
                    document.getElementById('createPrBtn').disabled = false;
                }
            }

            async loadBranches(repo) {
                try {
                    const response = await fetch(
                        `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.branches}/${repo.owner.login}/${repo.name}/branches`,
                        { credentials: 'include' }
                    );

                    if (!response.ok) {
                        throw new Error(`HTTP ${response.status}`);
                    }

                    const branches = await response.json();
                    const branchSelect = document.getElementById('branchSelect');
                    
                    branchSelect.innerHTML = branches.map(branch => 
                        `<option value="${branch.name}">${branch.name}</option>`
                    ).join('');
                    
                    // Set default branch
                    if (repo.default_branch) {
                        branchSelect.value = repo.default_branch;
                        this.appState.updateState('selectedBranch', repo.default_branch);
                    }

                } catch (error) {
                    console.error('Failed to load branches:', error);
                    Utils.showToast('Failed to load branches', 'error');
                    document.getElementById('branchSelect').innerHTML = '<option value="">Failed to load branches</option>';
                }
            }

            async createPullRequest() {
                if (!this.appState.selectedRepo || !this.appState.generatedContent) {
                    Utils.showToast('Please select a repository and generate documentation first', 'error');
                    return;
                }

                const repo = this.appState.selectedRepo;
                const baseBranch = document.getElementById('branchSelect').value;
                const prTitle = document.getElementById('prTitle').value;
                const prDescription = document.getElementById('prDescription').value;
                const commitMessage = document.getElementById('commitMessage').value;

                if (!baseBranch || !prTitle || !commitMessage) {
                    Utils.showToast('Please fill in all required fields', 'error');
                    return;
                }

                try {
                    Utils.showLoading('Creating pull request...', 'Creating branch and pushing changes');

                    const filename = this.appState.currentPurpose === 'readme' ? 'README.md' : 'documented_code.md';

                    const prData = {
                        title: prTitle,
                        body: prDescription,
                        base: baseBranch,
                        content: this.appState.generatedContent,
                        filename: filename,
                        commit_message: commitMessage
                    };

                    const response = await fetch(
                        `${API_CONFIG.baseUrl}${API_CONFIG.endpoints.createPR}/${repo.owner.login}/${repo.name}/pulls`,
                        {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                            },
                            credentials: 'include',
                            body: JSON.stringify(prData)
                        }
                    );

                    if (!response.ok) {
                        const errorData = await response.json();
                        throw new Error(errorData.error || 'Failed to create pull request');
                    }

                    const result = await response.json();
                    
                    Utils.showToast(
                        `Pull request created successfully! <a href="${result.pr_url}" target="_blank" style="color: var(--primary-color); text-decoration: underline;">View PR #${result.pr_number}</a>`,
                        'success',
                        8000
                    );

                } catch (error) {
                    console.error('Failed to create PR:', error);
                    Utils.showToast('Failed to create pull request: ' + error.message, 'error');
                } finally {
                    Utils.hideLoading();
                }
            }
        }

        // Documentation Manager with Real API Integration
        class DocumentationManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                const generateBtn = document.getElementById('generateBtn');
                const downloadBtn = document.getElementById('downloadBtn');
                const copyBtn = document.getElementById('copyBtn');

                generateBtn.addEventListener('click', () => this.generateDocumentation());
                downloadBtn.addEventListener('click', () => this.downloadDocumentation());
                copyBtn.addEventListener('click', () => this.copyDocumentation());
            }

            async generateDocumentation() {
                if (this.appState.uploadedFiles.length === 0) {
                    Utils.showToast('Please upload at least one file', 'error');
                    return;
                }

                const projectName = document.getElementById('projectName').value;
                const customInstructions = document.getElementById('customInstructions').value;

                if (this.appState.currentPurpose === 'readme' && !projectName) {
                    Utils.showToast('Please enter a project name for README generation', 'error');
                    return;
                }

                Utils.showLoading('Generating documentation...', 'AI is analyzing your code and creating documentation', true);
                Utils.updateLoadingProgress(10);

                try {
                    // Prepare form data
                    const formData = new FormData();
                    for (const file of this.appState.uploadedFiles) {
                        formData.append('files', file);
                    }
                    formData.append('purpose', this.appState.currentPurpose);
                    formData.append('project_name', projectName);
                    formData.append('custom_instructions', customInstructions);

                    Utils.updateLoadingProgress(30);

                    // Call API
                    const response = await fetch('/api/generate-docs', {
                        method: 'POST',
                        body: formData,
                        credentials: 'include'
                    });

                    Utils.updateLoadingProgress(70);

                    if (!response.ok) {
                        const error = await response.json();
                        throw new Error(error.error || 'Failed to generate documentation');
                    }

                    const result = await response.json();
                    Utils.updateLoadingProgress(90);

                    if (result.success) {
                        this.appState.updateState('generatedContent', result.content);
                        this.displayPreview(result.content, result.type);
                        
                        document.getElementById('downloadBtn').disabled = false;
                        document.getElementById('copyBtn').disabled = false;
                        
                        // Enable PR creation if repo is selected
                        if (this.appState.selectedRepo) {
                            document.getElementById('createPrBtn').disabled = false;
                            document.getElementById('directPushBtn').disabled = false;
                        }
                        
                        Utils.updateLoadingProgress(100);
                        Utils.hideLoading();
                        Utils.showSuccess('Documentation generated successfully!');
                    } else {
                        throw new Error('Failed to generate documentation');
                    }

                } catch (error) {
                    console.error('Error generating documentation:', error);
                    Utils.showToast(`Failed to generate documentation: ${error.message}`, 'error');
                } finally {
                    Utils.hideLoading();
                }
            }

            displayPreview(content, type) {
                const previewContainer = document.getElementById('previewContainer');
                previewContainer.innerHTML = '';

                if (type === 'readme') {
                    // Create markdown preview
                    const markdownDiv = document.createElement('div');
                    markdownDiv.className = 'markdown-preview';
                    markdownDiv.innerHTML = this.markdownToHtml(content);
                    previewContainer.appendChild(markdownDiv);
                } else {
                    // Display as code with syntax highlighting
                    const codeBlock = document.createElement('pre');
                    codeBlock.className = 'code-preview';
                    const code = document.createElement('code');
                    code.textContent = content;
                    codeBlock.appendChild(code);
                    previewContainer.appendChild(codeBlock);
                }

                // Animate preview appearance
                Utils.animateElement(previewContainer, 'fade-in');
            }

            markdownToHtml(markdown) {
                // Simple markdown to HTML converter
                let html = markdown
                    .replace(/^### (.*$)/gim, '<h3>$1</h3>')
                    .replace(/^## (.*$)/gim, '<h2>$1</h2>')
                    .replace(/^# (.*$)/gim, '<h1>$1</h1>')
                    .replace(/^\> (.*$)/gim, '<blockquote>$1</blockquote>')
                    .replace(/\*\*(.*)\*\*/gim, '<strong>$1</strong>')
                    .replace(/\*(.*)\*/gim, '<em>$1</em>')
                    .replace(/!\[([^\]]*)\]\(([^\)]*)\)/gim, '<img alt="$1" src="$2" />')
                    .replace(/\[([^\]]*)\]\(([^\)]*)\)/gim, '<a href="$2">$1</a>')
                    .replace(/```([^`]*?)```/gims, '<pre><code>$1</code></pre>')
                    .replace(/`([^`]*)`/gim, '<code>$1</code>')
                    .replace(/^\* (.*$)/gim, '<ul><li>$1</li></ul>')
                    .replace(/^\d+\. (.*$)/gim, '<ol><li>$1</li></ol>')
                    .replace(/\n/gim, '<br>');

                return html;
            }

            async downloadDocumentation() {
                if (!this.appState.generatedContent) {
                    Utils.showToast('No content to download', 'error');
                    return;
                }

                const fileExtension = this.appState.currentPurpose === 'readme' ? '.md' : '.txt';
                const fileName = `${this.appState.currentPurpose}-${Date.now()}${fileExtension}`;
                
                const blob = new Blob([this.appState.generatedContent], { type: 'text/plain' });
                const url = URL.createObjectURL(blob);
                
                const a = document.createElement('a');
                a.href = url;
                a.download = fileName;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                URL.revokeObjectURL(url);
                
                Utils.showToast('Documentation downloaded successfully!', 'success');
            }

            async copyDocumentation() {
                if (!this.appState.generatedContent) {
                    Utils.showToast('No content to copy', 'error');
                    return;
                }

                await Utils.copyToClipboard(this.appState.generatedContent);
            }
        }

        // Quality Analysis Manager
        class QualityAnalysisManager {
            constructor(appState) {
                this.appState = appState;
                this.init();
            }

            init() {
                const analyzeBtn = document.getElementById('analyzeBtn');
                analyzeBtn.addEventListener('click', () => this.analyzeCode());
            }

            async analyzeCode() {
                if (!this.appState.qualityFile) {
                    Utils.showToast('Please upload a file to analyze', 'error');
                    return;
                }

                Utils.showLoading('Analyzing code quality...', 'AI is examining your code for issues and improvements');

                try {
                    await new Promise(resolve => setTimeout(resolve, 4000));
                    
                    const mockResults = this.generateMockAnalysis();
                    this.displayResults(mockResults);
                    
                    Utils.showToast('Code analysis completed!', 'success');

                } catch (error) {
                    console.error('Error analyzing code:', error);
                    Utils.showToast('Failed to analyze code. Please try again.', 'error');
                } finally {
                    Utils.hideLoading();
                }
            }

            generateMockAnalysis() {
                return {
                    summary: "Your code shows good structure with room for improvement in error handling and documentation.",
                    metrics: {
                        "Code Quality": "B+",
                        "Maintainability": "85%",
                        "Security Score": "92%",
                        "Performance": "Good",
                        "Test Coverage": "78%",
                        "Documentation": "65%"
                    },
                    issues: [
                        {
                            line: 15,
                            message: "Consider adding error handling for this function call",
                            severity: "warning",
                            type: "error_handling"
                        },
                        {
                            line: 32,
                            message: "This variable name could be more descriptive",
                            severity: "info",
                            type: "naming"
                        },
                        {
                            line: 45,
                            message: "Potential security vulnerability: input validation needed",
                            severity: "error",
                            type: "security"
                        }
                    ],
                    suggestions: [
                        "Add comprehensive error handling throughout the codebase",
                        "Improve variable and function naming for better readability",
                        "Consider adding unit tests for critical functions",
                        "Add JSDoc comments for better documentation"
                    ]
                };
            }

            displayResults(results) {
                const resultsContainer = document.getElementById('resultsContainer');
                
                let html = '';

                if (results.summary) {
                    html += `
                        <div class="quality-summary" style="margin-bottom: var(--spacing-xl); padding: var(--spacing-lg); background: var(--bg-secondary); border-radius: var(--radius-lg); border-left: 4px solid var(--primary-color);">
                            <h4 style="margin-bottom: var(--spacing-sm); color: var(--text-primary);">Summary</h4>
                            <p style="color: var(--text-secondary);">${results.summary}</p>
                        </div>
                    `;
                }

                if (results.metrics) {
                    html += '<div class="quality-metrics">';
                    Object.entries(results.metrics).forEach(([key, value]) => {
                        html += `
                            <div class="metric-card">
                                <div class="metric-value">${value}</div>
                                <div class="metric-label">${key}</div>
                            </div>
                        `;
                    });
                    html += '</div>';
                }

                if (results.issues && results.issues.length > 0) {
                    html += '<div class="issues-section"><h4 style="margin-bottom: var(--spacing-lg); color: var(--text-primary);">Issues Found</h4>';
                    results.issues.forEach(issue => {
                        const severity = issue.severity ? issue.severity.toLowerCase() : 'info';
                        html += `
                            <div class="issue-item ${severity}">
                                <div class="issue-severity ${severity}">${issue.severity || 'INFO'}</div>
                                <div class="issue-content">
                                    <div class="issue-message">${issue.message || 'No description available'}</div>
                                    <div class="issue-line">Line ${issue.line || 'N/A'} â€¢ ${issue.type || 'General'}</div>
                                </div>
                            </div>
                        `;
                    });
                    html += '</div>';
                } else {
                    html += `
                        <div class="no-issues" style="text-align: center; padding: var(--spacing-2xl); color: var(--success-color);">
                            <h4 style="margin-bottom: var(--spacing-sm);">ðŸŽ‰ No issues found!</h4>
                            <p>Your code looks great!</p>
                        </div>
                    `;
                }

                if (results.suggestions && results.suggestions.length > 0) {
                    html += `
                        <div class="suggestions-section" style="margin-top: var(--spacing-xl);">
                            <h4 style="margin-bottom: var(--spacing-lg); color: var(--text-primary);">Suggestions</h4>
                            <ul style="margin-left: var(--spacing-lg);">
                    `;
                    results.suggestions.forEach(suggestion => {
                        html += `<li style="margin-bottom: var(--spacing-sm); color: var(--text-secondary);">${suggestion}</li>`;
                    });
                    html += '</ul></div>';
                }

                resultsContainer.innerHTML = html;
            }
        }

        // Main Application Class
        class TekshilaApp {
            constructor() {
                this.appState = new AppState();
                this.init();
            }

            init() {
                // Initialize managers
                this.authManager = new AuthManager(this.appState);
                this.themeManager = new ThemeManager();
                this.tabManager = new TabManager(this.appState);
                this.fileUploadManager = new FileUploadManager(this.appState);
                this.documentationManager = new DocumentationManager(this.appState);
                this.githubManager = new GitHubRepositoryManager(this.appState);
                this.qualityAnalysisManager = new QualityAnalysisManager(this.appState);

                // Set up global event listeners
                this.setupGlobalEventListeners();
                this.setDefaultValues();

                console.log('Tekshila application initialized successfully!');
            }

            setupGlobalEventListeners() {
                window.addEventListener('stateChange', (e) => {
                    const { key, value } = e.detail;
                    this.handleStateChange(key, value);
                });

                document.addEventListener('keydown', (e) => {
                    if (e.ctrlKey || e.metaKey) {
                        switch (e.key) {
                            case 'k':
                                e.preventDefault();
                                document.getElementById('fileInput').click();
                                break;
                            case 'Enter':
                                if (e.target.tagName === 'INPUT' || e.target.tagName === 'TEXTAREA') {
                                    const generateBtn = document.getElementById('generateBtn');
                                    if (!generateBtn.disabled) {
                                        generateBtn.click();
                                    }
                                }
                                break;
                        }
                    }
                });
            }

            handleStateChange(key, value) {
                switch (key) {
                    case 'generatedContent':
                        if (value && this.appState.selectedRepo) {
                            document.getElementById('createPrBtn').disabled = false;
                        }
                        break;
                }
            }

            setDefaultValues() {
                document.getElementById('prTitle').value = 'docs: add AI-generated documentation';
                document.getElementById('prDescription').value = 'This PR adds comprehensive documentation generated by AI to improve code understanding and maintainability.';
                document.getElementById('commitMessage').value = 'docs: add AI-generated documentation';
            }
        }

        // Global instances
        let app;
        let fileUploadManager;
        let githubManager;

        // Initialize application when DOM is loaded
        document.addEventListener('DOMContentLoaded', () => {
            app = new TekshilaApp();
            fileUploadManager = app.fileUploadManager;
            githubManager = app.githubManager;
        });

        // Export for potential module usage
        if (typeof module !== 'undefined' && module.exports) {
            module.exports = { TekshilaApp, Utils };
        }
    </script>
</body>
</html>